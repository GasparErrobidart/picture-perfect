function PicturePerfect(img){for(var picture=img.parentElement,maxWindowSize=window.innerWidth,sources=[],i=0;i<picture.childNodes.length;i++){var node=picture.childNodes[i];node.tagName&&"SOURCE"==node.tagName&&sources.push({dom:node,format:node.getAttribute("type").replace("image/",""),originalSrcset:node.getAttribute("srcset")||"",originalDataSrcset:node.getAttribute("data-srcset")||""})}var proximityThreshold=window.innerHeight/2;try{proximityThreshold=eval(picture.getAttribute("data-threshold"))||proximityThreshold}catch(e){console.log(e)}var automaticSizes="false"==picture.getAttribute("data-automatic-sizes")||!0,automaticSrcset="false"==picture.getAttribute("data-automatic-srcset")||!0,densities=(picture.getAttribute("data-densities")||"1").split(",").map(function(e){return parseFloat(e)}),url=picture.getAttribute("data-dynamic-url")||"";function handPickSizeFor(){return Math.ceil(img.getBoundingClientRect().width/window.innerWidth*100)+"vw"}function setElementSizes(e){picture.childNodes.forEach(function(e){e.tagName&&-1<["SOURCE","IMG"].indexOf(e.tagName)&&e.setAttribute("sizes",handPickSizeFor())})}function updateSources(){var r=Math.ceil(img.getBoundingClientRect().width);sources.forEach(function(e){var i=e.format,t=[];url&&automaticSrcset&&(t=densities.map(function(e){var t=Math.ceil(r*e);return url.replace(/\$\{format\}/gi,i.replace(/jpeg/gi,"jpg")).replace(/\$\{width\}/gi,t)+" "+t+"w"})),e.originalSrcset&&t.push(e.originalSrcset),e.originalDataSrcset&&t.push(e.originalDataSrcset),e.dom.setAttribute("srcset",t.join(","))})}var onResize=function(){automaticSizes&&setElementSizes(img),maxWindowSize<window.innerWidth&&(maxWindowSize=window.innerWidth,updateSources())},onProximity=function(){var e;automaticSizes&&setElementSizes(),updateSources(),window.addEventListener("resize",function(){clearTimeout(e),e=setTimeout(onResize,100)})},onScroll=function(){img.getBoundingClientRect().top-window.innerHeight<proximityThreshold&&(onProximity(),window.removeEventListener("scroll",onScroll))};window.addEventListener("scroll",onScroll),onScroll()}window.addEventListener("load",function(){document.querySelectorAll("picture > img[make-picture-perfect]").forEach(PicturePerfect)});