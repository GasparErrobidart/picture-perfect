function PicturePerfect(e,t){var i=this;t=t||{},i.options=t,i.img=e,i.img.className=i.img.className+=" picture-perfect",i.initialized=!(0!=t.lazy&&i.lazyLoad),i.maxWindowSize=window.innerWidth,i._calculateSizes=function(){0!=t.calculateSize&&i.setElementSize&&i.setElementSize(e)},i._updateSources=function(){0!=t.dynamicSources&&i.updateSources&&i.updateSources(i.img)},i._mimicBackgroundImage=function(){0!=t.mimicBackgroundImage&&i.mimicBackgroundImage&&i.mimicBackgroundImage(i.img)},i.onProximity=function(){i.initialized=!0,i.img.className=i.img.className+=" picture-perfect-ready",i.img.addEventListener("load",i.onLoad),window.addEventListener("resize",function(){setTimeout(i.onResize,100)}),i._calculateSizes(),i._updateSources()},i.onResize=function(){i.maxWindowSize<window.innerWidth&&(i.maxWindowSize=window.innerWidth,i._updateSources()),i._calculateSizes(),i._mimicBackgroundImage()},i.onLoad=function(e){i._mimicBackgroundImage()},i.initialized?i.onProximity():i.lazyLoad(),i._mimicBackgroundImage()}var JIT_IMG=function(e,t){new PicturePerfect(e,t),e.onload=null};PicturePerfect.prototype.lazyLoadAttributes=function(e,t){t.forEach(function(t){var i=e.getAttribute("lazy-"+t);"background-image"==t&&i?e.style.backgroundImage='url("'+i+'")':i&&e.setAttribute(t,i)})},PicturePerfect.prototype.lazyLoad=function(){var onScroll,rect,self=this,proximityThreshold=window.innerHeight/2,img=self.img;try{proximityThreshold=eval(img.getAttribute("lazy-threshold"))||proximityThreshold}catch(e){console.log(e)}onScroll=function(){if((rect=img.getBoundingClientRect()).top-window.innerHeight<proximityThreshold){window.removeEventListener("scroll",onScroll);var e=img.parentElement;e&&/picture/gi.test(e.tagName)&&e.childNodes.forEach(function(e){/source/gi.test(e.tagName)&&self.lazyLoadAttributes(e,["src","srcset","background-image"])}),self.lazyLoadAttributes(img,["src","srcset","background-image"]),self.onProximity()}},window.addEventListener("scroll",onScroll),onScroll()},PicturePerfect.prototype.handPickSizeFor=function(e){return Math.ceil(e.getBoundingClientRect().width/window.innerWidth*100)+"vw"},PicturePerfect.prototype.setElementSize=function(e){e.setAttribute("sizes",this.handPickSizeFor(e))},PicturePerfect.prototype.getDynamicEndpoint=function(e,t){if(e){(t=t||{}).density||(t.density="1");var i=parseFloat(t.density),n=this.img.getBoundingClientRect(),r=Math.ceil(n.width)||100,c=Math.ceil(n.height);return t.rawWidth=n.width,t.rawHeight=n.height,t.width=Math.ceil(r*i),t.height=Math.ceil(c*i),Object.keys(t).forEach(function(i){var n=new RegExp("\\$\\{"+i+"\\}","gi");e=e.replace(n,t[i])}),{url:e,params:t}}},PicturePerfect.prototype.extractDynamicSourceOptions=function(e){var t={dynamicSrcDensity:e.getAttribute("dynamic-src-density")||""+window.devicePixelRatio,dynamicSrc:e.getAttribute("dynamic-src"),dynamicSrcSetDensities:e.getAttribute("dynamic-srcset-densities")||""+window.devicePixelRatio,dynamicSrcSet:e.getAttribute("dynamic-srcset"),dynamicBackgroundImageDensity:e.getAttribute("dynamic-background-url-density")||""+window.devicePixelRatio,dynamicBackgroundImage:e.getAttribute("dynamic-background-image"),mime:(e.getAttribute("type")||"").replace("image/","")};return Object.keys(t).forEach(function(e){t[e]||delete t[e]}),t},PicturePerfect.prototype.updateSources=function(e){var t=this,i=e.parentElement,n={},r=[e];if(i&&/picture/gi.test(i.tagName)){n=t.extractDynamicSourceOptions(i);for(var c=0;c<i.childNodes.length;c++)/source/gi.test(i.childNodes[c].tagName)&&r.push(i.childNodes[c])}r.forEach(function(e){var i=Object.assign({},n,t.extractDynamicSourceOptions(e));if(["dynamicSrc","dynamicBackgroundImage"].forEach(function(n){if(i[n]){var r={density:i[n+"Density"],mime:i.mime},c=t.getDynamicEndpoint(i[n],r);"dynamicSrc"==n?e.setAttribute("src",c.url):e.style.backgroundImage='url("'+c.url+'")'}}),i.dynamicSrcSet){var r=[];i.dynamicSrcSetDensities.split(",").forEach(function(e){var n={density:e,mime:i.mime},c=t.getDynamicEndpoint(i.dynamicSrcSet,n);r.push(c.url+" "+c.params.width+"w")}),e.setAttribute("srcset",r.join(","))}})},PicturePerfect.prototype.getCurrentSrcSize=function(e,t){var i=new Image;i.onload=function(){t({width:i.width,height:i.height})},i.src=e.currentSrc},PicturePerfect.prototype.mimicBackgroundImage=function(e){var t=e.closest("[mimic-background-image-wrapper]"),i=e.closest("[mimic-background-image-container]");if(!i||!t)return!1;this.getCurrentSrcSize(e,function(n){var r=t.currentStyle||window.getComputedStyle(t),c="cover"==r.backgroundSize,o="contain"==r.backgroundSize,a=i.getBoundingClientRect(),d=n.width/n.height*a.height,s=(n.height,n.width,a.width,a.width),u=a.height,l=d>=a.width;c?(l?s=d:u=n.height/n.width*a.width,e.style.width=l?"auto":"100%",e.style.height=l?"100%":"auto"):o&&(l?u=n.height/n.width*a.width:s=d,e.style.width=l?"100%":"auto",e.style.height=l?"auto":"100%");var m=r.backgroundPosition.split(" "),g=m[0],h=m[1];if(console.log("Bg position",g,h),g.indexOf("px")>-1)e.style.left=g;else if(g.indexOf("%")>-1){var y=parseFloat(g.replace("%",""));e.style.left=(a.width-s)*(y/100)+"px"}else e.style.left=(a.width-s)/2+"px";if(h.indexOf("px")>-1)e.style.top=h;else if(h.indexOf("%")>-1){y=parseFloat(h.replace("%",""));e.style.top=(a.height-u)*(y/100)+"px"}else e.style.top=(a.height-u)/2+"px"})};